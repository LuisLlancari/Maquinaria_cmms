{% extends 'core/base.html' %} 

{% block titulo %}Inicio{% endblock %} 

{% block contenido %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<h1 class="text-center">REPORTES</h1>
<div class="alert alert-danger alert-dismissible fade show" style="display: none;" id="error-alert" role="alert">
    <strong id="mensaje-alert"></strong>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<!-- BOTONES EXPORTAR -->
<div class="d-flex md gap-1 mb-3">
    <button type="button" class="btn btn-success flex-grow-1" data-bs-toggle="modal" data-bs-target="#modalExportExcel">
        <i class="bi bi-file-earmark-excel"></i>
        <h5><strong class="text-uppercase ">Excel</strong></h5>
    </button>
    <button type="button" class="btn btn-danger flex-grow-1" data-bs-toggle="modal" data-bs-target="#modalExportPDF">
        <i class="bi bi-filetype-pdf"></i>
        <h5><strong>PDF</strong></h5>
    </button>
</div>

<!-- FILTROS -->
<div class="row">
    <div class="col col-md-4 mb-1">
        <label for="" class="form-label"><strong>FECHA:</strong></label>
        <input type="date" name="" class="form-control" id="fecha">
    </div>
    <div class="col col-md-4 mb-1">
        <label for="" class="form-label"><strong>SUPERVISOR:</strong></label>
        <select name="" class="form-select" id="supervisor">
            {% for data in usuarios %}
            <option value="{{ data.id }}">{{ data.first_name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col col-md-4 mb-1">
        <label for="" class="form-label"><strong>TURNO:</strong></label>
        <select name="" class="form-select" id="turno">
            <option value="M">Mañana</option>
            <option value="T">Tarde</option>
            <option value="N">Noche</option>
        </select>
    </div>
</div>

<!-- CONTENERDOR GRAFICO Y TABLA -->
<div class="container mt-2">
    <div class="row">

        <div class="col col-md-6">
            <h1 class="text-center mt-2">Gráfico</h1>
            <canvas id="grafico-donut"></canvas>
        </div>

        <div class="col col-md-6">
            <table class="table table-bordered table-sm table-hover mt-2" id="tabla-tractor">
            <thead class="text-center table-dark">
                <tr>
                    <th>Fundos</th>
                    <th>Total</th>
                    <th>Activos</th>
                    <th>Inactivos</th>
                </tr>
            </thead>
            <tbody class="text-center ">
                
            </tbody>
            </table>
        </div>
    </div>
</div>

    
    
<div class="modal fade" id="modalExportPDF" tabindex="-1" aria-labelledby="modalExportPDFLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalExportPDFLabel">Exportar PDF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'exportpdf' %}" id="formExportarPDF" method="POST">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col">
                            <label for="fecha_inicio" class="form-label">Fecha de inicio:</label>
                            <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio">
                        </div>
                        <div class="col">
                            <label for="fecha_fin" class="form-label">Fecha de fin:</label>
                            <input type="date" class="form-control" id="fecha_fin" name="fecha_fin">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="usuario" class="form-label">Usuario:</label>
                            <select id="selectuser" class="form-control" id="usuario" name="usuario">
                                <option selected disabled>Seleccione un Usuario</option>
                                {% for data in usuarios %}
                                <option value="{{ data.id }}">{{ data.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col">
                            <label for="labor" class="form-label">Labor:</label>
                            <select class="form-control" id="labor" name="labor">
                                <option selected disabled>Seleccione Una Labor</option>
                                {% for data in tipolabor %}
                                <option value="{{ data.idtipolabor }}">{{ data.idtipolabor__tipolabor }}</option>
                                {% endfor %}
                            </select>
                        </div>        
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <button type="submit" class="btn btn-primary">Exportar Formato PDF</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalExportExcel" tabindex="-1" aria-labelledby="modalExportExcelLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalExportExcelLabel">Exportar Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'exportar' %}" id="formExportarExcel" method="POST">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col">
                            <label for="fecha_inicio" class="form-label">Fecha de inicio:</label>
                            <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio">
                        </div>
                        <div class="col">
                            <label for="fecha_fin" class="form-label">Fecha de fin:</label>
                            <input type="date" class="form-control" id="fecha_fin" name="fecha_fin">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="usuario" class="form-label">Usuario:</label>
                            <select id="selectuser" class="form-control" id="usuario" name="usuario">
                                <option selected disabled>Seleccione un Usuario</option>
                                {% for data in usuarios %}
                                <option value="{{ data.id }}">{{ data.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col">
                            <label for="labor" class="form-label">Labor:</label>
                            <select class="form-control" id="labor" name="labor">
                                <option selected disabled>Seleccione Una Labor</option>
                                {% for data in tipolabor %}
                                <option value="{{ data.idtipolabor }}">{{ data.idtipolabor__tipolabor }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <button type="submit" class="btn btn-primary">Exportar Formato Excel</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>    
    
    // Instanciamos elementos de la hoja del gráfico y los filtros
    const tabla = document.querySelector('#tabla-tractor tbody')
    const canvas = document.getElementById('grafico-donut')
    const Fecha = document.getElementById('fecha')
    const Supervisor = document.getElementById('supervisor')
    const Turno = document.getElementById('turno')


    // Asignar la fecha actual al campo de fecha
    let fechaActual = new Date().toISOString().split('T')[0];
    Fecha.value = fechaActual;

    // Variable para instanciar gráfico 
    let graficoDona = null;

    // Colores para el gráfico
    const backgroundColors = [
    "rgba(103, 109, 123, 1)",  
    "rgba(102, 178, 255, 1)",  
    "rgba(102, 255, 102, 1)",  
    "rgba(178, 102, 255, 1)",  
    "rgba(255, 102, 255, 1)",
    "rgba(102, 255, 178, 1)",
    "rgba(255, 178, 178, 1)",
    "rgba(178, 178, 255, 1)",
    "rgba(178, 255, 178, 1)",
    "rgba(255, 178, 255, 1)",
    "rgba(255, 255, 102, 1)",
    "rgba(255, 153, 0,   1)",  
    "rgba(255, 51,  102, 1)", 
    "rgba(51,  153, 255, 1)", 
    "rgba(51,  204, 51,  1)",  
    "rgba(153, 51,  255, 1)", 
    "rgba(255, 51,  255, 1)", 
    "rgba(51,  255, 153, 1)", 
    "rgba(255, 102, 102, 1)",
    "rgba(102, 102, 255, 1)",
    "rgba(102, 255, 102, 1)",
    "rgba(255, 102, 255, 1)",
    "rgba(255, 255, 51,  1)", 
];

    // Gráfico
    graficoDona = new Chart(canvas,{
        type: 'doughnut',
        data: {
        labels: [
        ],
        datasets: [{
            label: ['cantidad'],
            data: [],
            backgroundColor: backgroundColors
         }]
        },
        

    });

    // Traer datos del gráfico y la tabla
    async function datos_graficos(fecha, supervisor, turno) {
        try {
            const response = await fetch(`./datos_graficos/${fecha}/${supervisor}/${turno}`);
            let datos = await response.json();
            // console.log(datos.resultados_solicitantes);

            graficoDona.data.labels = datos.resultados_solicitantes.map(registro => registro.nombre)
            graficoDona.data.datasets[0].data = datos.resultados_solicitantes.map(registro => registro.registros)

            graficoDona.update();

        } catch (error) {
            console.log(error);
        }
    }
   
    async function datos_tabla(fecha, supervisor, turno) {
        try {
            const response = await fetch(`./datos_tabla/${fecha}/${supervisor}/${turno}`);
            let datos = await response.json();
            console.log(datos);

            tabla.innerHTML = '';
            datos.tabla_tractor.forEach(registro => {
                nuevafila = 
                `<tr>
                    <td>${registro.nombre_fundo}</td>
                    <td>${registro.tractores_totales}</td>
                    <td>${registro.tractores_programados}</td>
                    <td>${registro.tractores_sin_programar}</td>
                   
                </tr>`;
                tabla.innerHTML += nuevafila;   

            });

        } catch (error) {
            console.log(error);
        }
    }

    // Filtros
    Fecha.addEventListener("change",function() {
        let fecha = Fecha.value
        let supervisor = Supervisor.value
        let turno = Turno.value

        datos_graficos(fecha,supervisor,turno);
        datos_tabla(fecha,supervisor,turno);

    });

    Supervisor.addEventListener("change",function() {
        let fecha = Fecha.value
        let supervisor = Supervisor.value
        let turno = Turno.value
        console.log(fecha, supervisor, turno)
        datos_graficos(fecha,supervisor,turno);
        datos_tabla(fecha,supervisor,turno);


        
    });

    Turno.addEventListener("change",function() {
        let fecha = Fecha.value
        let supervisor = Supervisor.value
        let turno = Turno.value
        datos_graficos(fecha,supervisor,turno);
        datos_tabla(fecha,supervisor,turno);


    });

</script>

{% endblock %}
