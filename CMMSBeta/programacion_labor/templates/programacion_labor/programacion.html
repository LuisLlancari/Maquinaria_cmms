{% extends 'core/base.html' %}

{% block titulo %}implemento{% endblock%}

{% block contenido %} 
<div class="container">
    <h1 class="text-center mb-3">Creacion de Programacion de Labor</h1>
    <div class="row">
        <div class="col-md-4">
            <input type="text" id="buscador" class="form-control mb-2" placeholder="Buscar...">
        </div>
        <div class="col-md-6"></div>
        <div class="col-md-2">
            {% if user.idrol.rol == "Supervisor" %}
            <button type="button" class="btn btn-success obtener" data-toggle="modal" data-target="#modalNuevo">Nueva Programacion
            </button>
            {% endif %}
        </div>
    </div>
    <div class="table-responsive mt-4">
        {% if messages %}
            {% for message in messages %}
            <div id="message" class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                
                {{ message }}
                
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        
        {% endif %}
        <div class="">
            <strong>Fecha: {{fecha}}</strong>
        </div>
        <strong class="text-primary">Tractores utilizados: {{ cantidad }}</strong>
        <table class="table table-striped table-sm table-bordered mt-3"  id="tabla-labor">
            <thead>
                <tr class="table-dark">
                    <th scope="col">N°</th>
                    <th scope="col">Tipo de Labor</th>
                    <th scope="col">Lote</th>
                    <th scope="col">Solicitante</th>
                    <th scope="col">Tractor</th>
                    <th scope="col">Tractorista</th>
                    <th scope="col">Fecha Programada</th>
                    <th scope="col">Turno</th>
                    <th scope="col">Horas de Uso</th>
                    <th scope="col">Implementos</th>
                    {% if user.idrol.rol == "Admin" %}
                    <th scope="col">Operaciones</th>
                    {% endif %}
                </tr>
            </thead>

            <tbody>
                {% for det in detalle %}
                <tr>
                    <th scope="row">{{ forloop.counter }}</th>
                    <td>{{ det.idprogramacion.idtipolabor }}</td>
                    <td>
                        {{ det.idprogramacion.idlote.idfundo }}
                        -
                        {{ det.idprogramacion.idlote }}
                    </td>
                    <td>
                        {{ det.idprogramacion.idsolicitante.idpersona.nombres }}
                        {{ det.idprogramacion.idsolicitante.idpersona.apellidos }}
                    </td>
                    <td {% if det.idprogramacion.idtractor.idusuario.id != user.id %} class="bg-warning" {% endif %}>{{ det.idprogramacion.idtractor }}</td>
                    <td {% if det.idprogramacion.idtractorista.idusuario.id != user.id %} class="bg-warning" {% endif %} >
                        {{ det.idprogramacion.idtractorista.idpersona.nombres }}
                        {{ det.idprogramacion.idtractorista.idpersona.apellidos }}
                    </td>
                    <td>{{ det.idprogramacion.fechahora}}</td>
                    <td>{{ det.idprogramacion.turno}}</td>

                    <!-- Para manejar la confirmacion-->
                    {% if det.horadeuso == 0 %}
                        <td class="text-danger">
                            <strong> Por Confirmar </strong>
                        </td>
                    {% else %}
                    <td class="text-primary text-end">
                        <strong>{{det.horadeuso}}</strong>
                    </td>
                    {% endif %}
                    <!--FIN DE LA CONFIRMACION-->

                    <td class="text-center">
                        <button class="btn {% if det.idimplemento.idusuario.id != user.id %}btn-warning{% else %}btn-primary{% endif %} btn-sm btn-ver"  data-toggle="modal" data-implementos="{{ det.idimplemento }}" data-idprogramacion='{{ det.idprogramacion }}' data-target="#modalListImplemento">
                            <i class="lni lni-eye"></i>
                        </button>
                    </td>
                    {% if user.idrol.rol == "Admin" %}
                    <td>
                        <!-- <button class="btn btn-warning btn-sm editar d-inline-block" id="tipolabor" data-toggle="modal"
                            data-target="#modalEditar" data-idtipolabor="{{ data.idtipolabor }}"
                            data-nombretipolabor="{{ data.tipolabor }}" type="button"><i
                            class="lni lni-pencil"></i></button> -->
                            <form action="{% url 'eliminar_programacion' det.iddetlabor %}" class="d-inline-block" 
                            method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm mx-5"><i
                                class="lni lni-trash-can"></i></button>
                            </form>
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <h1 id="h1-remplazar" class="text-center"></h1>
    </div>

    <!-- Modal Registrar Ceco -->
    <div class="modal fade" id="modalNuevo" tabindex="-1" role="dialog" aria-labelledby="modalNuevoLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success">
                    <h1 class="modal-title text-white" id="modalProgramacion">Nueva Programacion</h1>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'registrar_programacion' %}" autocomplete="off" id="form-ceco">
                        {% csrf_token %}
                        <strong for="idcimplemnto" >Datos Generales:</strong>
                        <div class="row mt-3">
                            <div class="col-md-0">
                                <!-- <label for="idtractorista">Tractorista:</label>
                                <select name="idtractorista" class="form-select mb-2" id="id_idtractorista" required>
                                    <option value="">---------</option>
                                    {% for i in tractorista %}
                                    <option value="{{i.idtractorista}}">{{i.idpersona.nombres}} {{i.idpersona.apellidos}}</option>
                                    {% endfor %}
                                </select> -->
                            </div>
                            <div class="col-md-4">
                                <label for="turn4o">Fecha de labor:</label>
                                <select name="fechahora" class="form-select mb-2" id="id_fechahora">
                                    <option id="1" value="hoy">Hoy</option>
                                    <option id="2" value="mañana">Mañana</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="turno">Turno:</label>
                                {{form_programacion.turno}}
                            </div>
                            <div class="col-md-5">
                                <label for="fechahora">Solicitante:</label>
                                {{form_programacion.idsolicitante}}
                            </div>
                            
                            
                        </div>
                        

                        <!--ESTE INPUT OCULTA EL USUARIO QUE ESTA LOGUEADO-->
                        <div>
                            <input type="hidden" name="idusuario" id="idprogramacion" value="{{idusuario}}">
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="idfundo">Selecione el Fundo:</label>
                                <select name="idfundo" id="idfundo" class="form-select">
                                    <option value="">---------</option>
                                    {% for i in fundo %}
                                    <option value="{{i.idfundo}}">{{i.fundo}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="idlote" >Lote:</label>
                                <select name="idlote" class="form-control mb-2" id="id_idlote">
                                    <option value="">---------</option>
                                    {% for i in lotes %}
                                    <option data-idfundo="{{i.idfundo.idfundo}}" value="{{i.idlote}}">{{i.lote}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="idtractor">Tipo de Labor:</label>
                                {{form_programacion.idtipolabor}}
                            </div>
                        </div>

                        <!--FIN-->
                        <div class="row mt-3">
                            <!-- <div class="col-md-4">
                                <label for="idlote" >Tipo de labor:</label>
                                {{form_programacion.idtipolabor}}
                            </div> -->
                            <!-- <div class="col-md-4">
                                <label for="idsolicitante">Lote:</label>
                                {{form_programacion.idlote}}
                            </div> -->
                            <!-- <div class="col-md-4">
                                <label for="idtractor">Nombre del Tractor:</label>
                                <select name="idtractor" class="form-control mb-2" required id="id_idtractor">
                                    <option value="">---------</option>
                                    {% for i in tractor %}
                                    <option value="{{i.idtractor}}">{{i.nrotractor}}</option>
                                    {% endfor %}
                                </select>
                            </div> -->
                        </div>
                        
                        <hr>

                        <strong class="text-center">Supervisor:</strong>

                        <div class="row mt-2">
                            
                            <div class="col-md-4 bg-primary">
                                <div class="row mt-2">
                                    <div class="col-md-8">
                                        <select name="usuario_id" class="form-select" id="usuario_id">
                                            {% for supervisor in lista_usuarios %}
                                            <option value="{{ supervisor.id }}">{{ supervisor.first_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-2 mt-2">
                                    <div class="col-md-8">
                                        <strong for="idimplemento" >Lista de implementos a usar:</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-success float-end" id="btn-agregar">
                                            Agregar
                                        </button>
                                    </div>
                                    <div class="implementos-container mt-2">
                                        <select name="idimplemento" class="form-select mb-2" id="id_idimplemento" required>
                                            <option value="">---------</option>
                                            {% for implemento in implementos %}
                                            <option data-idusuario="{{ implemento.idusuario_id }}" value="{{ implemento.idimplemento }}">{{ implemento.implemento }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4 bg-success">                            
                                <div class="row mt-2">
                                    <div class="col-md-8">
                                        <select name="usuario_id" class="form-select" id="usuario_id_2" required>
                                            {% for supervisor in lista_usuarios %}
                                            <option value="{{ supervisor.id }}">{{ supervisor.first_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-2 mt-2">
                                    <strong for="idimplemento" >Selecione el Tractor:</strong>
                                    <div class="mt-4">
                                        <select name="idtractor" id="id_idtractor" class="form-select" required>
                                            <option value="">---------</option>
                                            {% for data in tractor %}
                                            <option data-idusuario="{{data.idusuario.id}}" value="{{data.idtractor}}">{{data.nrotractor}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 bg-secondary">                            
                                <div class="row mt-2">
                                    <div class="col-md-8">
                                        <select name="usuario_id" class="form-select" id="usuario_id_3" required>
                                            {% for supervisor in lista_usuarios %}
                                            <option value="{{ supervisor.id }}">{{ supervisor.first_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-2 mt-2">
                                    <strong for="idimplemento">Selecione al Tractorista:</strong>
                                    <div class="mt-4">
                                        <select name="idtractorista" id="id_idtractorista" class="form-select" required>
                                            <option value="">---------</option>
                                            {% for data in tractorista %}
                                            <option data-idusuario="{{data.idusuario.id}}" value="{{data.idtractorista}}">{{data.idpersona}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            

                        </div>


                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalListImplemento" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="">Lista de Implementos</h5>
                </div>
                <div class="modal-body">

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {

        const h1 = document.querySelector('#h1-remplazar');
        const buscador = document.querySelector('#buscador');
        const filasTabla = document.querySelectorAll('#tabla-labor tbody tr');

        function filtrarTabla() {
            const valorBusqueda = buscador.value.trim().toLowerCase();
            let noHayResultados = true;
            filasTabla.forEach(fila => {
                const lote = fila.querySelector('td:nth-child(3)').textContent.trim().toLowerCase();
                const Tractorista = fila.querySelector('td:nth-child(6)').textContent.trim().toLowerCase();

                const coincide = lote.includes(valorBusqueda);
                const coincide2 = Tractorista.includes(valorBusqueda);

                if (coincide || coincide2) {
                    fila.style.display = 'table-row';
                    noHayResultados = false;
                } else {
                    fila.style.display = 'none';
                }
            });
            h1.textContent = noHayResultados ? 'Datos no encontrados' : '';
        }

        //Eventos
        buscador.addEventListener('input', filtrarTabla);

        //MANEJO DE FECHAS
        let selectFecha = document.getElementById('id_fechahora');
        let option_1 = document.getElementById('1');
        let option_2 = document.getElementById('2'); 
    
        let fechaActual = new Date();
        let fechaMañana = new Date();
        fechaMañana.setDate(fechaMañana.getDate() + 1);
        
        let hoy = fechaActual.toISOString().split('T')[0];
        let mañana = fechaMañana.toISOString().split('T')[0];

        option_1.value = hoy;
        option_2.value = mañana;
        
        selectFecha.addEventListener('change', () => {
            let seleccion = selectFecha.value;
            console.log(seleccion);
        });
        //FIN DE MANEJO DE FECHAS

        //CAMBIA EL VALOR POR QUE SE ENCUENTRA LOGUEADO
        usuario_id.value = "{{idusuario}}";
        usuario_id_2.value = "{{idusuario}}";
        usuario_id_3.value = "{{idusuario}}";
        console.log(usuario_id.value);  

        let selectUsuario = document.getElementById('usuario_id');
        let selectedUserId = document.getElementById('usuario_id').value;

        let selectUsuario2 = document.getElementById('usuario_id_2');
        let selectTractor = document.getElementById('id_idtractor');

        let selectUsuario3 = document.getElementById('usuario_id_3');
        let selectTractorista = document.getElementById('id_idtractorista');

        let fundo = document.getElementById('idfundo');
        let lote = document.getElementById('id_idlote').value;

        function filtrarTractoresPorUsuario(userId) {
            let tractorOptions = document.querySelectorAll('#id_idtractor option');
            tractorOptions.forEach(option => {
                if (option.dataset.idusuario !== userId && option.value !== '') {
                    option.style.display = 'none';
                } else {
                    option.style.display = 'block';
                }
            });
        }     
        
        function filtrarImplementosPorUsuario(userId) {
            let implementoOptions = document.querySelectorAll('#id_idimplemento option');
            implementoOptions.forEach(option => {
                if (option.dataset.idusuario !== userId && option.value !== '') {
                    option.style.display = 'none';
                } else {
                    option.style.display = 'block';
                }
            });
        }

        function filtrarTractoristasPorUsuario(userId) {
            let tractoristaOptions = document.querySelectorAll('#id_idtractorista option');
            tractoristaOptions.forEach(option => {
                if (option.dataset.idusuario !== userId && option.value !== '') {
                    option.style.display = 'none';
                } else {
                    option.style.display = 'block';
                }
            });
        }

        function filtrarLotesPorFundo(fundoId) {
            let loteOptions = document.querySelectorAll('#id_idlote option');
            loteOptions.forEach(option => {
                if (option.dataset.idfundo !== fundoId && option.value !== '') {
                    option.style.display = 'none';
                } else {
                    option.style.display = 'block';
                }
            });
        }

        selectUsuario.addEventListener('change', function() {
            let selectedUserId = this.value;
            filtrarImplementosPorUsuario(selectedUserId);
        });

        selectUsuario2.addEventListener('change', function() {
            let selectedUserId = this.value;
            filtrarTractoresPorUsuario(selectedUserId);
        });

        selectUsuario3.addEventListener('change', function() {
            let selectedUserId = this.value;
            filtrarTractoristasPorUsuario(selectedUserId);
        });

        fundo.addEventListener('change', function() {
            let selectedTractorId = this.value;
            filtrarLotesPorFundo(selectedTractorId);
        });
        
        let maxImplementos = 3;
        document.getElementById('btn-agregar').addEventListener('click', () => {
            let implementosAgregados = document.querySelectorAll('.implementos-container select').length;
            if (implementosAgregados < maxImplementos) {
                var selectClonado = document.getElementById('id_idimplemento').cloneNode(true);        
                document.querySelector('.implementos-container').appendChild(selectClonado);
            } else {
                if (!document.querySelector('.implementos-container .text-danger')) {
                    var mensaje = document.createElement('span');
                    mensaje.textContent = '¡Has alcanzado el máximo de implementos permitidos!';
                    mensaje.classList.add('text-danger', 'ms-2');
                    document.querySelector('.implementos-container').insertBefore(mensaje, document.querySelector('.implementos-container').firstChild);
                }
            }
        });
        
        document.querySelectorAll('.btn-ver').forEach(button => {
            button.addEventListener('click', function() {
                let idProgramacion = this.getAttribute('data-idprogramacion');
                console.log(idProgramacion);
                fetch(`./obtener_data/${idProgramacion}`)
                .then(response => response.json())
                .then(data => {
                    if (data.mensaje === "Success") {
                        var modalBody = document.querySelector('#modalListImplemento .modal-body');
                        modalBody.innerHTML = '';
                        var ul = document.createElement('ul');
                        data.nombres_implementos.forEach(nombre => {
                            var li = document.createElement('li');
                            li.textContent = nombre;
                            ul.appendChild(li);
                        });
                        modalBody.appendChild(ul);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });


        
        
        //Llamado de funciones
        filtrarImplementosPorUsuario(selectedUserId);
        filtrarTractoresPorUsuario(selectTractor);
        filtrarTractoristasPorUsuario(selectTractorista);
        filtrarLotesPorFundo(lote);

        //Funcion que se disparan automatico
        selectFecha.dispatchEvent(new Event('change'));
        selectUsuario.dispatchEvent(new Event('change'));
        selectUsuario2.dispatchEvent(new Event('change'));
        selectUsuario3.dispatchEvent(new Event('change'));
        
        //Funcion para que el mensaje tenga un tiempo de espera de 3 segundos
        setTimeout(function() {
            var errorMessage = document.getElementById('message');
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
        },3000);

        });
</script>

{% endblock %}
