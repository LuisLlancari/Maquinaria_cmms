{% extends 'core/base.html' %}

{% block titulo %}Implementos Ingreso{% endblock%}

{% block contenido %} 
<div class="container">
  <h1 class="text-center">Ingreso de implemento</h1>
  <!-- filtros -->
  <div class="row"></div>
  <!-- fin filtro -->

  <div class="container">
    <div class="row" id="contenido-cards"></div>
    <div id="no-results-message" class="alert alert-danger text-center" style="display: none;">
      No hay implementos por aceptar
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const contenerdoCards = document.getElementById('contenido-cards');
    const noResultsMessage = document.getElementById('no-results-message');
    var CSRF_TOKEN = '{{ csrf_token }}';

    function registrarIngreso(idmantenimiento){
      console.log("hola")
      fetch(`./pendiente/registrar_ingreso/${idmantenimiento}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
      })
      .then(res => res.json())
      .then(datos => {
        if (datos.status === 'success') {
          // Manejar el éxito de la operación y redireccionar
          console.log('Ingreso registrado con éxito');
          window.location.href = './pendiente'; // Cambia esta ruta a la deseada
        } 
      })
      .catch((error) => {
          console.log(error);
      });
    }

    function rederizarMantenimientosPendientes(datos){
      contenerdoCards.innerHTML = '';
      if (datos.length === 0) {
        noResultsMessage.style.display = 'block';
      } else {
        noResultsMessage.style.display = 'none';
        datos.forEach(pendiente => {
          let nuevaCard = `
          <div class="col col-md-4">
            <div class="card border-success mb-3" >
              <div class="card-header bg-transparent border-success text-center">Mantenimiento ${pendiente.idmantenimiento}</div>
                <div class="card-body text-success">
                  <h5 class="card-text text-center fw-bold"></h5>
                  <p class="card-text text-success m-0 fs-5"><strong>Implemento: </strong> ${pendiente.implemento}</p>
                  <p class="card-text text-success m-0 fs-5"><strong>Codigo:  </strong> ${pendiente.cod_implemento}</p>
                  <p class="card-text text-success m-0 fs-5"><strong>Fecha Programacion:</strong> ${pendiente.fecha_programada}</p>
                </div>
                <div class="card-footer bg-transparent border-success">
                  <form>
                    <button class="btn btn-primary mt-1 w-100 confirmar" data-id="${pendiente.idmantenimiento}">Confirmar Llegada</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          `;
          contenerdoCards.innerHTML += nuevaCard;
        });

        const btnConfimarFecha = document.querySelectorAll('.confirmar');
        btnConfimarFecha.forEach(function(boton) {
          boton.addEventListener("click", function(event) {
            event.preventDefault();
            let id_mantenimiento = event.currentTarget.dataset.id;
            registrarIngreso(id_mantenimiento);
          });
        });
      }
    }

    function obtenerDatosMantenimientosPendientes(){
      fetch(`./pendiente/datos_mantenimiento`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
      })
      .then(res => res.json())
      .then(datos => {
        rederizarMantenimientosPendientes(datos.mantenimiento);
      })
      .catch((error) => {
          console.log(error);
      });
    }

    obtenerDatosMantenimientosPendientes();

  });
</script>

{% endblock %}