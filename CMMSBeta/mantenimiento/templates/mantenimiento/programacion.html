{% extends 'core/base.html' %} 

{% block titulo %}Programaci칩n mantenimiento{% endblock %} 

{% block contenido %}
<h1 class="text-center">Programaci칩n de los Mantenimientos</h1>

<div class="d-flex justify-content-end m-4">
  <button class="btn btn-primary" data-toggle="modal" data-target="#programar">Crear programacion</button>
</div>

<table class="table table-striped table-sm table-bordered text-center table-responsive mt-3" id="tabla-implemento">
  <thead class="thead-dark">
    <tr>
      <th>Implemento</th>
      <th>Tipo Implemento</th>
      <th>Codigo</th>
      <!-- <th>Tiempo Vida</th> -->
      <th>Horas de uso</th>
      <th>F M</th>
      <th>Fecha Asignada</th>
      <th>Tipo Mantenimiento</th>
    </tr>
  </thead>
  <tbody>
    {% for dato in datos %}
    <tr>
      <td>{{dato.idimplemento.implemento}}</td>
      <td>{{dato.idimplemento.idtipoimplemento.tipoimplemento}}</td>
      <td>{{dato.idimplemento.codimplemento}}</td>
      <!-- <td>{{dato.idimplemento.idtipoimplemento.tiempo_vida}}</td> -->
      <td>{{dato.idimplemento.horasdeuso}}</td>
      <td>{{dato.idimplemento.idtipoimplemento.frecuencia_man}}</td>
      {% if dato.tipomantenimiento == 1 %}
      <td>Preventivo</td>
      {% else %}
      <td>Correctivo</td>
      {% endif %}
      {% if dato.fechaprogramacion %}
      <td>{{dato.fechaprogramacion}}</td>
      {% else %}
      <td>
        <button class="btn btn-warning editar d-inline-block registrar" id="registrar-fecha" data-id="{{dato.idimplemento.idimplemento}}" data-imple_nombre="{{dato.idimplemento.implemento}}" data-idprogramacion="{{dato.idprogramacionmantenimiento}}"  data-bs-toggle="modal" data-bs-target="#registro_fecha">Programar Fecha</button>
      </td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="modal fade" id="registro_fecha" tabindex="-1" aria-labelledby="registro_fecha_label" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header bg-primary justify-content-center">
        <h1 class="modal-title fs-5 text-light" id="titulo-modal">Registrar Fecha Mantenimiento</h1>
      </div>

      <form autocomplete="off" id="form-modal" method="POST">
        {% csrf_token %}
        <div class="modal-body">
          <input type="text" name="idprogramacion" id="idprogramacion" value="0" hidden>
          <label for="" class="form-label">Fecha de la programaci칩n</label>
          <input type="date" name="fecha_programacion" id="fecha" class="form-control" required>

          <label for="" class="form-label mt-3" name="1" id="label_implemento">Motivos del mantenimiento:</label>
          <button type="button" id="clone-motivos" class="btn btn-success ms-2">A침adir Motivo</button>

          <select name="idmotivo" id="selectMotivo" class="form-control mt-3" disabled>
            {% for dato in acciones %}
              <option value="{{dato.idaccion}}">{{dato.accion}}</option>
            {% endfor %}
          </select>

          <div id="comienza">
            
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" id="Guardar" class="btn btn-outline-primary flex-fill">Guardar</button>
          <button type="button" id="cerrar" class="btn btn-outline-danger flex-fill" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="programar" tabindex="-1" aria-labelledby="registro_fecha_label" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header bg-primary justify-content-center">
        <h1 class="modal-title fs-5 text-light" id="titulo-modal">Registrar Fecha</h1>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split('T')[0];
    const fecha = document.getElementById('fecha');
    const formModal = document.getElementById("form-modal");
    const btnCloneMotivos = document.getElementById('clone-motivos');
    const nombre = document.getElementById('label_implemento');

    fecha.setAttribute('min', today);
    selectMotivo.value = 12

    var btnRegistrarFecha = document.querySelectorAll('.registrar');
    btnRegistrarFecha.forEach(function (button) {
      button.addEventListener('click', function () {
        let id_implemento = this.dataset.id;
        let imple_nombre = this.dataset.imple_nombre;
        let idprog = this.dataset.idprogramacion;

        console.log(id_implemento)
        formModal.setAttribute("action", `./programacion/registrar_fecha/${id_implemento}`)

        document.getElementById('label_implemento').innerHTML = `Motivos del mantenimiento ${imple_nombre} :`;
      });
    });

    formModal.addEventListener('submit', function() {
      selectMotivo.disabled = false;
    });

    btnCloneMotivos.addEventListener('click', () => {
      let clone = `
            <div id="motivos-container" class="mt-3">
              <div class="contenedor-motivos">
                <div class="row mb-3">
                  <div class="col-md-9">
                    <select name="idmotivo" id="selectMotivos" class="form-control mt-3">
                      <option value="">-------------------------------------</option>
                      {% for dato in acciones %}
                        <option value="{{dato.idaccion}}">{{dato.accion}}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-3 mt-3">
                    <button type="button" class="btn btn-danger btn-remove">Eliminar</button>
                  </div>
              </div>
            </div>
      `

      comienza.innerHTML += clone;
    });

    document.addEventListener('click', (event) => {
      if (event.target.classList.contains('btn-remove')) {
        event.target.closest('#motivos-container').remove();
      }
    });

  });
</script>

{% endblock %}
